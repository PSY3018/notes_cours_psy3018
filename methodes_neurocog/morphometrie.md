---
jupytext:
  cell_metadata_filter: -all
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.10.3
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---
(morphometrie-chapitre)=
# Analyses morphom√©triques

<table>
  <tr>
    <td align="center">
      <a href="https://github.com/eddyfortier">
        <img src="https://avatars.githubusercontent.com/u/72314243?v=4?s=100" width="100px;" alt=""/>
        <br /><sub><b>Eddy Fortier</b></sub>
      </a>
      <br />
        <a title="Contenu">ü§î</a>
        <a title="R√©vision du texte">üëÄ</a>
    </td>
    <td align="center">
      <a href="https://github.com/pbellec">
        <img src="https://avatars.githubusercontent.com/u/1670887?v=4?s=100" width="100px;" alt=""/>
        <br /><sub><b>Pierre bellec</b></sub>
      </a>
      <br />
        <a title="Contenu">ü§î</a>
        <a title="Quizz">‚ö†Ô∏è</a>
        <a title="R√©vision du texte">üëÄ</a>
    </td>
  </tr>
</table>

```{warning}
Ce chapitre est en cours de d√©veloppement. Il se peut que l'information soit incompl√®te, ou sujette √† changement.
```

## Objectifs du cours

Ce cours introduit diff√©rentes approches pour quantifier la morphologie du cerveau √† l'aide des donn√©es d'imagerie par r√©sonance magn√©tique anatomique. On va tout d'abord pr√©senter trois grandes approches d'analyses:
 * la **volum√©trie manuelle**, qui vise a mesurer la taille d'une r√©gion c√©r√©brale;
 * la **morphom√©trie bas√©e voxel (*voxel-based morphometry* ou VBM)**, qui vise √† mesurer le volume de mati√®re grise syst√©matiquement partout dans le cerveau;
 * les **analyses de surface**, qui exploitent la structure en ruban de la mati√®re grise.

On parlera √©galement d'√©tapes d'analyse d'images utiles pour l'ensemble de ces techniques, telles que le **recalage**, la **segmentation**, et le **contr√¥le de qualit√©**.

## Morphom√©trie

```{figure} ./morphometrie/morphometrie_durer.jpg
---
width: 600px
name: morphometrie-durer-fig
---
√âtude de D√ºrer sur les proportions du visage. Image sous domaine public, tir√©e de [wikimedia](https://commons.wikimedia.org/wiki/File:Morpho_durer.JPG).
```

En neurosciences, la [morphom√©trie](https://fr.wikipedia.org/wiki/Morphom%C3%A9trie) est l'√©tude de la forme du cerveau et de ses structures.
Le terme morphom√©trie vient de deux termes tir√©s du grec ancien: *morphos* (forme) et *m√©tron* (mesure).
La morphom√©trie est donc la "mesure" de la "forme".
Cette discipline se concentre sur la caract√©risation des dimensions et des formes des diff√©rentes structures d'int√©r√™t.
Pour ce faire, il est n√©cessaire de pouvoir observer clairement les d√©limitations de ces structures.

```{figure} ./morphometrie/ledig2018.webp
---
width: 600px
name: ledig2018-fig
---
Cette figure illustre les diff√©rences morphologiques entre individus qui pr√©sentent des profils cliniques diff√©rents: cognitivement normal (haut), troubles l√©gers de la cognition (milieu), d√©mence de type Alzheimer (bas). Par ailleurs on peut √©galement observer des diff√©rences longitudinales au sein d'un m√™me individu (de gauche √† droite, visite initiale, suivi √† deux ans, diff√©rence des deux images). Figure tir√©e de {cite:p}`Ledig2018-ai`, sous licence CC-BY.
```
L'utilisation de ce genre de technique permet aussi de faire des comparaisons inter-individuelles.
On pourrait en effet vouloir comparer les variations dans la forme de divers structures √† travers les cerveaux de diff√©rentes personnes.
De telles comparaisons peuvent √™tre informatrices au niveau du stade d√©veloppemental d'un sujet, ou m√™me, de la pr√©sence de certaines l√©sions ou pathologies.

## Volum√©trie

### Segmentation manuelle

```{figure} ./morphometrie/ashempour2019.jpg
---
width: 600px
name: ashempour2019-fig
---
Cette figure illustre un protocole de segmentation manuelle de l'amygdale. Vue coronale d'une segmentation manuelle de l'amygdale gauche (jaune) et droit (bleu) avant (gauche) et apr√®s (droite) corrections dans le plan coronal. Figure tir√©e de {cite:p}`Hashempour2019-jq`, sous licence CC-BY.
```

La **volum√©trie manuelle** constiste √† manuellement d√©limiter une aire c√©r√©brale particuli√®re, comme l'hippocampe ou l'amygdale (voir {numref}`ashempour2019-fig`). Cette approche n√©cessite du temps, car chaque coupe d'IRM doit √™tre d√©limit√©e manuellement. On commencera d'abord par identifier ce contour sur chaque coupe o√π la structure est pr√©sente dans un premier plan (par exemple, sur une coupe axiale), puis il faudra aller corriger cette d√©limitation sur chaque coupe prise dans un second plan (comme une coupe sagitale) et finalement, r√©p√©ter de nouveau cette correction sur le troisi√®me plan (une coupe coronale).

> Pour un rappel concernant les diff√©rents types de coupes du cerveau, veuillez vous r√©f√©rer au {ref}`Chapitre 1: Cartes c√©r√©brales <coupes-tip>`.

Ce type d'approche requiert √©galement un protocole de segmentation rigoureux, avec des crit√®res anatomiques claires pour d√©cider o√π une r√©gion c√©r√©brale se trouve. Pour certaines structures, comme les ventricules lat√©raux, c'est assez clair. Pour d'autres structures, comme l'hippocampe, il existe des protocoles d√©taill√©s, voir par exemple {cite:p}`Wisse2017-ff`. Enfin pour d'autres r√©gions, comme les aires visuelles V1, V2, etc, il est n√©cessaire de r√©aliser des exp√©riences fonctionnelles pour les d√©limiter, et les d√©limitations anatomiques ne sont pas n√©cessairement disponibles ou bien √©tablies.

Un protocole de segmentation clair est n√©cessaire pour assurer un bon niveau de reproductibilit√© des r√©sultats et un [accord inter-juge](https://en.wikipedia.org/wiki/Inter-rater_reliability) acceptable. Certains protocoles offrent une certification, qui offre un certain niveau de garantie que la chercheuse effectuant la segmentation applique le protocole correctement.

### Segmentation automatique

```{code-cell} ipython 3
:tags: ["hide-input", "remove-output"]

# T√©l√©chargement de l'atlas Harvard-Oxford
from nilearn import datasets

# Enl√®ve les warnings
import warnings
warnings.filterwarnings("ignore")

atlas = datasets.fetch_atlas_harvard_oxford('cort-maxprob-thr25-2mm').maps
mni = datasets.fetch_icbm152_2009()

# Visualisation de la figure
import matplotlib.pyplot as plt
from myst_nb import glue
from nilearn import plotting

fig = plt.figure(figsize=(12, 4))
plotting.plot_roi(atlas,
    bg_img=mni.t1,
    axes=fig.gca(),
    title="Harvard Oxford atlas",
    cut_coords=(8, -4, 9),
    colorbar=True,
    cmap='Paired')

glue("harvard-oxford-fig", fig, display=False)
```

```{glue:figure} harvard-oxford-fig
:figwidth: 800px
:name: "harvard-oxford-fig"

Un exemple d'atlas de r√©gions anatomiques: l'atlas Harvard-Oxford. Cette figure est g√©n√©r√©e par du code python √† l'aide de la librairie [nilearn](https://nilearn.github.io/) √† partir d'un jeu de donn√©es public appel√© fetch_atlas_harvard_oxford ([Nilearn, section 9.2.1: Basic Atlas plotting](https://nilearn.github.io/auto_examples/01_plotting/plot_atlas.html)) {cite:p}`MAKRIS2006155, Frazier2005, DESIKAN2006968, GOLDSTEIN2007935` (cliquer sur + pour voir le code).
```

Afin d'automatiser le travail de segmentation, il est possible d'utiliser une segmentation d√©j√† effectu√©e par une √©quipe de chercheurs dans un espace de r√©f√©rence, encore appel√© espace st√©r√©otaxique. On appelle ces segmentations de r√©f√©rence des atlas, ou parfois parcellisations. Comme il existe une vari√©t√© de parcellisations correspondant √† diff√©rents crit√®res anatomiques ou fonctionnels, il est important de choisir ad√©quatement l'atlas en fonction des structures particuli√®res que vous voulez √©tudier. L'IRM structurelle d'un participant est {ref}`recal√©e <registration-tip>` de mani√®re automatis√©e vers l'{ref}`espace st√©r√©otaxique <stereotaxique-tip>` de r√©f√©rence, et cette transformation permet d'adapter l'atlas √† l'anatomie du sujet.

```{admonition} Recalage
:class: tip
:name: registration-tip

Afin d'appliquer un atlas de r√©gions c√©r√©brales sur une IRM individuelle, il est n√©cessaire de recaler cette IRM sur l'espace st√©r√©otaxique qui a √©t√© utilis√© pour √©tablir les r√©gions. Ce processus math√©matique va chercher √† d√©former l'image individuelle vers l'espace st√©r√©otaxique. Cette transformation peut √™tre affine (notamment translation, rotation, mise √† l'√©chelle) ou bien non-lin√©aire (d√©placement dans n'importe quelle direction de l'espace). L'objectif du recalage est de rendre les images plus similaires possible, mais il est important que les d√©formations soient continues. Autrement dit, des endroits adjacents dans les images non-recal√©es doivent toujours √™tre adjacents apr√®s le recalage. Les images ci dessous illustrent l'effet de diff√©rents types de recalage, et sont tir√©es de la documentation du logiciel [slicer](https://www.slicer.org/wiki/Documentation:Nightly:Registration:RegistrationLibrary:RegLib_C42) sous licence CC-Attributions Share Alike.
```{figure} morphometrie/registration_slicer_raw.gif
:figwidth: 400px
:align: left
:figclass: margin-caption
Images brutes: deux scans du m√™me sujet, prises √† des jours diff√©rents.

```{figure} morphometrie/registration_slicer_affine.gif
:figwidth: 400px
:align: left
:figclass: margin-caption
Images recal√©es apr√®s une transformation affine.

```{figure} morphometrie/registration_slicer_nonlinear.gif
:figwidth: 400px
:align: left
:figclass: margin-caption
Images recal√©es apr√®s une transformation non-lin√©aire.

```{figure} morphometrie/registration_slicer_nonlinear_only.gif
:figwidth: 400px
:align: left
:figclass: margin-caption
Effet du recalage non-lin√©aire seulement
```

```{code-cell} ipython 3
:tags: ["hide-input", "remove-output"]
# Ce code r√©cup√®re des donn√©es IRM T1
# et g√©n√®re une image dans trois plans de coupes

# Enl√®ve les warnings
import warnings
warnings.filterwarnings("ignore")

# T√©l√©charge un scan anatomique (template MNI152)
from nilearn.datasets import fetch_icbm152_2009
mni = fetch_icbm152_2009()

# Visualise le volume c√©r√©bral
import matplotlib.pyplot as plt
from myst_nb import glue
from nilearn.plotting import plot_anat

fig = plt.figure(figsize=(12, 4))
plot_anat(
  mni.t1,
  axes=fig.gca(),
  cut_coords=[-17, 0, 17],
  title='Espace stereotaxique MNI152'
)
glue("mni-template-fig", fig, display=False)
```

```{admonition} Espace st√©r√©otaxique
:class: tip
:name: stereotaxique-tip

Afin de d√©finir une anatomie de r√©f√©rence, les chercheurs utilisent g√©n√©ralement un cerveau "moyen". Le cerveau de plusieurs dizaines d'individus sont recal√©es les uns avec les autres, puis moyenn√©s pour obtenir une seule image. Si le recalage a bien fonctionn√©, les d√©tails de la neuroanatomie sont pr√©serv√©s dans la moyenne.
```{glue:figure} mni-template-fig
:figwidth: 600px
:align: left
Espace st√©r√©otaxique de l'Institut Neurologique de Montr√©al (MNI), moyenne de 152 sujets apr√®s recalage non-lin√©aire it√©ratif {cite:p}`Fonov2011-xr`.

```
### Analyses statistiques
```{figure} ./morphometrie/ledig2018_stats.png
---
width: 400px
name: ledig2018-stats-fig
---
Cette figure illustre les diff√©rences de volume de l'hippocampe entre participants cognitivement sains (HC), participants avec troubles cognitifs l√©gers stables (sMCI) ou progressifs (pMCI), ou patients avec une d√©mence de type Alzheimer (AD), dans la cohorte ADNI. Plus les sympt√¥mes cliniques sont s√©v√®res, plus la probabilit√© de pr√©senter la maladie d'Alzheimer est grand, et plus le stade de la maladie est s√©v√®re. L'atrophie de l'hippocampe est claire chez les patients pr√©sentant les sympt√¥mes les plus s√©v√®res. Figure tir√©e de {cite:p}`Ledig2018-ai`, sous licence CC-BY.
```
Pour les analyses statistiques, on extrait le volume de chaque structure segment√©e (en $mm^3$), et on peut par exemple comparer statistiquement le volume moyen entre deux groupes, ou tester l'association du volume avec une variable comme l'√¢ge. Par exemple, dans la {numref}`ledig2018-stats-fig`, on compare le volume de l'hippocampe entre diff√©rents groupes cliniques avec diff√©rents risques de la maladie d'Alzheimer.

## Morphom√©trie bas√©e voxel (VBM)

### Densit√© de mati√®re grise
La morphom√©trie bas√©e voxel (VBM) a pour objectif de mesurer le volume de mati√®re grise imm√©diatement autour d'un voxel donn√©. Cette approche n'est donc pas limit√©e par le besoin d'avoir des fronti√®res pr√©√©tablies claires entre diff√©rentes structures c√©r√©brales.
Lorsque l'on g√©n√®re une mesure de volume pour l'ensemble des voxels du cerveau, on obtient une carte 3D de la densit√© de mati√®re grise.
L'avantage premier de cette approche est d'√™tre automatis√©e et syst√©matique. La pr√©sence d'une personne ne devient n√©cessaire que pour v√©rifier que la proc√©dure a fonctionn√© correctement, une √©tape appel√©e contr√¥le qualit√© (ou QC, pour "quality control"). On va aussi tester la morphologie du cerveau au travers de l'ensemble de la mati√®re grise. Mais le grand nombre de mesures diff√©rentes g√©n√©r√©es pose un  probl√®me de _comparaisons multiples_ lorsque vient le temps de faire les analyses statistiques, voir le [Chapitre 10: Cartes statistiques](cartes_statistiques.html).

### Segmentation
```{code-cell} ipython 3
:tags: ["hide-input", "remove-output"]
# Importe les librairies n√©cessaires
import matplotlib.pyplot as plt
import numpy as np
from myst_nb import glue
import seaborn as sns

import warnings
warnings.filterwarnings("ignore")

# T√©l√©charge un scan anatomique (template MNI152)
from nilearn import datasets
mni = datasets.fetch_icbm152_2009()

# Initialise la figure
fig = plt.figure(figsize=(15, 15))

from nilearn.plotting import plot_stat_map
from nilearn.image import math_img
from nilearn.input_data import NiftiMasker

thresh = 0.8
coords = [-5, 5, -25]

# Full brain
ax_plot = plt.subplot2grid((4, 3), (0, 0), colspan=1)
mask_brain = math_img(f"img>{thresh}", img=mni.mask)
val_brain = NiftiMasker(mask_img=mask_brain).fit_transform(mni.t1)
ax = sns.distplot(val_brain, norm_hist=False)
ax.set_xlim(left=0, right=100)
ax_plot = plt.subplot2grid((4, 3), (0, 1), colspan=2)
plot_stat_map(mni.mask,
              bg_img=mni.t1,
              cut_coords=coords,
              axes=ax_plot,
              black_bg=True,
              title='cerveau'
              )

# Gray matter
ax_plot = plt.subplot2grid((4, 3), (1, 0), colspan=1)
mask_gm = math_img(f"img>{thresh}", img=mni.gm)
val_gm = NiftiMasker(mask_img=mask_gm).fit_transform(mni.t1)
ax = sns.distplot(val_gm, norm_hist=False)
ax.set_xlim(left=0, right=100)
ax_plot = plt.subplot2grid((4, 3), (1, 1), colspan=2)
plot_stat_map(mni.gm,
              bg_img=mni.t1,
              cut_coords=coords,
              axes=ax_plot,
              black_bg=True,
              title='mati√®re grise'
              )

# White matter
ax_plot = plt.subplot2grid((4, 3), (2, 0), colspan=1)
mask_wm = math_img(f"img>{thresh}", img=mni.wm)
val_wm = NiftiMasker(mask_img=mask_wm).fit_transform(mni.t1)
ax = sns.distplot(val_wm, norm_hist=False)
ax.set_xlim(left=0, right=100)
ax_plot = plt.subplot2grid((4, 3), (2, 1), colspan=2)
plot_stat_map(mni.wm,
              bg_img=mni.t1,
              cut_coords=coords,
              axes=ax_plot,
              black_bg=True,
              title='mati√®re blanche'
              )

# CSF
ax_plot = plt.subplot2grid((4, 3), (3, 0), colspan=1)
mask_csf = math_img(f"img>{thresh}", img=mni.csf)
val_csf = NiftiMasker(mask_img=mask_csf).fit_transform(mni.t1)
ax = sns.distplot(val_csf, axlabel="intensit√© de l'image", norm_hist=False)
ax.set_xlim(left=0, right=100)
ax_plot = plt.subplot2grid((4, 3), (3, 1), colspan=2)
plot_stat_map(mni.csf,
              bg_img=mni.t1,
              cut_coords=coords,
              axes=ax_plot,
              black_bg=True,
              title='liquide cephalo rachidien'
              )

from myst_nb import glue
glue("mni-segmentation-fig", fig, display=False)
```
```{glue:figure} mni-segmentation-fig
:figwidth: 600px
:name: mni-segmentation-fig
Segmentation probabiliste des principaux types de tissus, et distribution des valeurs pond√©r√©es en T1 dans les voxels "purs" (probabilit√© sup√©rieure √† 80% pour un type de tissu donn√©). L'image pond√©r√©e en T1 ainsi que les segmentations correspondent √† l'espace st√©r√©otaxique MNI152 {cite:p}`Fonov2011-xr`.
```
Une √©tape importante de la VBM est la segmentation. Cette analyse vise √† cat√©goriser les diff√©rents tissus du cerveau en classes, notamment mati√®re grise, mati√®re blanche et liquide c√©phalo-rachidien. On va aussi g√©n√©ralement extraire un masque du cerveau et exclure les m√©ninges ainsi que le cr√¢ne. On va g√©n√©ralement inclure d'autres types de tissus √©galement, comme la graisse. Un algorithme de segmentation va examiner la distribution des niveaux de gris dans l'image, par exemple pond√©r√©e en T1, et estimer pour chaque voxel la proportion du voxel qui contient un tissu donn√©. Cette proportion est souvent appel√© {ref}`effet de volume partiel <volume-partiel-tip>`. Un voxel peut par exemple √™tre assign√© √† 80% de mati√®re grise et 20% de liquide c√©phalo-rachidien.

```{admonition} Effets de volume partiel
:class: tip
:name: volume-partiel-tip
Il est possible que la segmentation automatique nous retourne certains tissus non-d√©sir√©s, mais dont les valeurs dont les valeurs dans l'image sont similaires √† celle de la mati√®re grise. Il est ainsi possible que des voxels se trouvant directement sur la jonction entre une zone blanche et une zone noire (par exemple, sur une paroi de mati√®re blanche qui borderait un ventricule) aient comme valeur r√©sultante une valeur s'apparentant plut√¥t au gris associ√© √† la mati√®re grise (valeur moyenne entre blanc et noir). On appelle ce genre d'effet de m√©lange de noir et de blanc les volumes partiels (une partie du volume du voxel est blanche alors que l'autre partie est noire).
```

```{admonition} Erreurs de segmentation
:class: tip
Il est possible de perdre certaines structures pour lequelles le contraste entre la mati√®re blanche et mati√®re grise n'est pas assez important pour que l'algorithme r√©ussisse √† les classifier efficacement. Pour ce genre de structure, il est important d'ajouter des a priori (des r√®gles, ou conditions suppl√©mentaires) afin de ne pas les perdre. Il est aussi envisageable de corriger cette partie de la segmentation de fa√ßon manuelle.

```{figure} ./morphometrie/segmentation-error-volume-fig.png
---
width: 600px
name: segmentation-error-volume-fig
---
Image de gauche: IRM individuelle pond√©r√©e en T1. Image de droite: classification mati√®re grise et mati√®re blanche g√©n√©r√©e par le logiciel [ANTS](http://stnava.github.io/ANTs/). Notez comment la mati√®re blanche proche du gyrus est classifi√© de mani√®re erronn√©e comme mati√®re grise. Image sous licence CC Attribution, tir√©e de Klein et al., 2017 {cite:p}`Klein2017-zh`.
```

### Lissage
```{code-cell} ipython 3
:tags: ["hide-input", "remove-output"]
# Improte les librairies n√©cessaires
import matplotlib.pyplot as plt
import numpy as np
from myst_nb import glue
import seaborn as sns

import warnings
warnings.filterwarnings("ignore")

# T√©l√©charge un scan anatomique (template MNI152)
from nilearn import datasets
mni = datasets.fetch_icbm152_2009()

# Initialise la figure
fig = plt.figure(figsize=(15, 15))

from nilearn.plotting import plot_anat
from nilearn.image import math_img
from nilearn.input_data import NiftiMasker
from nilearn.image import smooth_img

list_fwhm = (0, 5, 8, 10)
n_fwhm = len(list_fwhm)
coords = [-5, 5, -25]

for num, fwhm in enumerate(list_fwhm):
    ax_plot = plt.subplot2grid((n_fwhm, 1), (num, 0), colspan=1)
    vol = smooth_img(mni.gm, fwhm)
    plot_anat(vol,
              cut_coords=coords,
              axes=ax_plot,
              black_bg=True,
              title=f'FWHM={fwhm}',
              vmax=1)

from myst_nb import glue
glue("smoothing-fig", fig, display=False)
```
```{glue:figure} smoothing-fig
:figwidth: 600px
:name: smoothing-fig
Illustration de l'impact du lissage sur une carte de densit√© de mati√®re grise en VBM. Lorsque le param√®re `FWHM` augmente, la mesure de densit√© repr√©sente une r√©gion entourant le voxel de plus en plus grande. Cette figure est g√©n√©r√©e par du code python √† l'aide de la librairie [nilearn](https://nilearn.github.io/) √† partir d'un jeu de donn√©es public appel√© template MNI152 2009 {cite:p}`Fonov2011-xr` (cliquer sur + pour voir le code).
```

L'√©tape suivante correspond au lissage spatial, qui consiste √† ajouter un filtre sur l'image qui va la rendre plus  floue. En pratique, le lissage remplace la valeur √† chaque voxel par une moyenne pond√©r√©e de ses voisins.
Comme c'est une moyenne pond√©r√©e, la valeur originale du voxel est celle qui aura la plus grande pond√©ration, mais les valeurs des voxels situ√©s directement autour vont aussi l'affecter grandement. La valeur des poids suit un profil de distribution Gaussienne 3D. Il est n√©cessaire de proc√©der √† cette √©tape afin d'obtenir des valeurs de densit√© de mati√®re grise pour des zones qui d√©passe le voxel unique, et analogue du volume d'une petite r√©gion, centr√©e sur le voxel. La taille de la r√©gion est contr√¥l√©e par un param√®tre de _largeur √† mi-hauteur_, ou `FWHM` (_full width at half maximum_), qui se mesure en millim√®tres. Plus la valeur de FWHM est grande, plus grand sera le rayon du voisinage de voxels qui auront un impact sur la valeur liss√©e du voxel, voir {numref}`smoothing-fig`.

### Analyses statistiques
```{code-cell} ipython 3
:tags: ["hide-input", "remove-output"]
import numpy as np
import matplotlib.pyplot as plt
from nilearn import datasets
from nilearn.input_data import NiftiMasker
from nilearn.image import get_data

n_subjects = 50  # more subjects requires more memory

# Charge les donn√©es
oasis_dataset = datasets.fetch_oasis_vbm(n_subjects=n_subjects)
gray_matter_map_filenames = oasis_dataset.gray_matter_maps
age = oasis_dataset.ext_vars['age'].astype(float)

# Pr√©traitement (mask)
nifti_masker = NiftiMasker(
    standardize=False,
    smoothing_fwhm=2,
    memory='nilearn_cache')  # cache options

# Normalise les donn√©es
gm_maps_masked = nifti_masker.fit_transform(gray_matter_map_filenames)

from sklearn.feature_selection import VarianceThreshold
variance_threshold = VarianceThreshold(threshold=.01)

gm_maps_thresholded = variance_threshold.fit_transform(gm_maps_masked)
gm_maps_masked = variance_threshold.inverse_transform(gm_maps_thresholded)
data = variance_threshold.fit_transform(gm_maps_masked)

# Mod√®le de r√©gression massivement univari√©
from nilearn.mass_univariate import permuted_ols
neg_log_pvals, t_scores_original_data, _ = permuted_ols(
    age, data,  # + intercept as a covariate by default
    n_perm=2000,  # 1,000 in the interest of time; 10000 would be better
    verbose=1, # display progress bar
    n_jobs=1)  # can be changed to use more CPUs
signed_neg_log_pvals = neg_log_pvals * np.sign(t_scores_original_data)
signed_neg_log_pvals_unmasked = nifti_masker.inverse_transform(
    variance_threshold.inverse_transform(signed_neg_log_pvals))

# Visualise les r√©sultats
threshold = -np.log10(0.1)  # 10% corrected

fig = plt.figure(figsize=(10, 3), facecolor='k')
bg_filename = gray_matter_map_filenames[0]
cut_coords = [0, 0, 0]
display = plot_stat_map(signed_neg_log_pvals_unmasked, bg_img=bg_filename,
                        threshold=threshold, cmap=plt.cm.RdBu_r,
                        cut_coords=cut_coords,
                        figure=fig)
title = ('Negative $\\log_{10}$ p-values'
         '\n(Non-parametric + max-type correction)')
display.title(title, y=1.2)
plt.show()

from myst_nb import glue
glue("vbm-fig", fig, display=False)
```
```{glue:figure} vbm-fig
:figwidth: 600px
:name: vbm-fig
R√©gression lin√©aire en VBM. On teste ici l'effet de l'√¢ge sur un groupe (N=50) de participants de la base de donn√©es OASIS. La significativit√© $-\log_{10}(p)$ de l'effet de l'√¢ge est pr√©sent√©e superpos√© √† une image de densit√© de mati√®re grise. Cette figure est adapt√© d'un tutoriel [Nilearn](https://nilearn.github.io/auto_examples/02_decoding/plot_oasis_vbm.html#sphx-glr-auto-examples-02-decoding-plot-oasis-vbm-py).
```
Afin de pouvoir comparer les valeurs de densit√© de mati√®re grise entre les sujets, on utilise la m√™me proc√©dure de {ref}`recalage <registration-tip>` non-lin√©aire que pour la volum√©trie automatique. Contrairement √† la volum√©trie manuelle o√π chaque volume √† l'√©tude est d√©limit√© de fa√ßon √† repr√©senter la m√™me structure d'int√©r√™t, le recalage utilis√© en VBM n'est pas li√© √† une structure particuli√®re. Une fois les cartes de densit√© recal√©es dans l'espace st√©r√©otaxique de r√©f√©rence, on peut faire des tests statistiques √† chaque voxel. Dans l'exemple ci-dessus, on teste l'effet de l'√¢ge sur la mati√®re grise. C'est g√©n√©ralement le genre d'image qui sera par la suite utilis√© lors de publications scientifiques.

> Les d√©tails concernant les mod√®les stastistiques seront pr√©sent√©s dans le chapitre sur la [r√©gression lin√©aire](regression.html).

## Analyses de surface

Cette famille d'approches diff√®re des pr√©c√©dentes en ce qu'elle ne mesure pas la densit√© de la mati√®re grise, mais plut√¥t sa r√©partition, son √©paisseur et/ou sa surface.
Cette fa√ßon de faire particuli√®re permet de faire des analyses sur l'ensemble de la surface corticale.
Par contre, qui dit surface corticale, sous-entend aussi que les structures sous-corticales sont laiss√©es de c√¥t√©.
Cette famille de techniques n'est donc pas recommand√©e pour un protocol de recherche durant lequel on voudrait √©tudier des structures enfouies dans la bo√Æte cr√¢nienne telles que l'hypothalamus, les ganglions de la base, etc.
Plut√¥t que de proc√©der √† l'analyse du contenu d'unit√©s de volume (voxels), comme c'√©tait le cas pour la VBM, on utilisera ici l'analyse du contenu d'unit√©s de surface: les **vertex**.
Ainsi, on cherche √† √©tudier √† l'aide de ceux-ci la forme que prend localement la mati√®re grise.

Le processus permettant d'arriver aux r√©sultats partage certaines similitudes avec les analyses volum√©triques, alors que d'autres √©tapes sont sp√©cifiques aux analyses de surface.
- En effet, la premi√®re √©tape consiste encore √† proc√©der au **pr√©traitement** (recalage et contr√¥le de qualit√©) et √† la **segmentation** des images du cerveau.
Par contre, certaines des √©tapes suivantes diff√®rent de celles utilis√©es lors des protocols de volum√©trie.
- De ce fait, la seconde √©tape vise √† **d√©limiter la fronti√®re** entre la surface de mati√®re grise et les tissus/milieux environnant.
Afin d'y parvenir, on utilisera des mod√®les permettant d'estimer la **surface piale** (surface ext√©rieure du cortex, √† la fronti√®re entre la mati√®re grise et le liquide c√©phalo-rachidien) et la **surface int√©rieure** (√† la fronti√®re entre la mati√®re grise et la mati√®re blanche).
Il faudra, pour y parvenir, √©liminer des images les structures n'appartenant pas au cortex (bo√Æte cr√¢nienne, tissus adipeux, m√©ninges, liquide c√©phalo-rachidien, etc.).
C'est l'√©tape de la cr√©ation du **masque** du cerveau.
Il est important de s'assurer, une fois que le masque est g√©n√©r√©, qu'il contient bel et bien l'ensemble du volume du cerveau, ni plus, ni moins.
Il y a en effet un aspect de contr√¥le de qualit√© qui doit √™tre v√©rifi√© √† ce stade afin de ne pas mettre en p√©ril l'ensemble des √©tapes suivantes.
- On proc√©dera ensuite √† la **d√©limitation des surfaces** piale et interne.
Pour ce faire, on mod√©lisera un volume en forme de ballon virtuel au centre de chacun des h√©misph√®res du cerveau.
On d√©finit ensuite des contraintes physiques (d√©limitation de la "cavit√©" interne dans laquelle le ballon peut √©voluer) afin de marquer la fronti√®re entre la mati√®re blanche et la mati√®re grise (surface interne).
On proc√®de ensuite √† "gonfler" ce ballon jusqu'√† ce qu'il √©pouse le mieux possible la fronti√®re de la surface interne (jusqu'√† ce que le ballon soit gonfl√© jusqu'√† occuper tout l'espace dans la cavit√© et suivre l'ensemble des courbes de la paroi).
Il est aussi possible de faire la proc√©dure inverse.
On pourrait en effet g√©n√©rer un ballon virtuel autour de chacun des h√©misph√®res et les "d√©gonfler" jusqu'√† ce qu'ils √©pousent les contours des fronti√®res d√©limit√©es par les contraintes physiques.
Lorsque l'une des fronti√®res (surface interne ou surface piale) est d√©limit√©es, il est possible de continuer la proc√©dure de gonflement/d√©gonflement afin d'obtenir la seconde surface.
On peut ensuite utiliser la distance entre les deux surfaces en un point donn√© afin d'√©valuer l'√©paisseur corticale pour ce vertex.
Cette distance est obtenue en prenant la perpendiculaire √† l'une des surfaces et en mesurant la distance entre les deux surfaces le long de cette perpendiculaire.
Ce genre de technique permet par la suite de g√©n√©rer des cartes d'√©paisseur corticale.

- La derni√®re √©tape des analyses de surfaces marque un retour aux similitudes avec les techniques de volum√©trie: c'est l'√©tape des **analyses statistiques**.

## Chaine de traitements
Comme pour toute op√©ration automatis√©e, il reste toujours une possibilit√© d'erreur au cours du processus de recalage.
Il est donc n√©cessaire de pr√©voir une √©tape de v√©rification des r√©sultats afin de s'assurer qu'il n'y a pas eu d'aberrations qui se sont introduites dans les donn√©es.
Ces aberrations peuvent venir de plusieurs sources diff√©rentes:
- Erreurs dans les √©tapes de recalage lin√©aire et/ou non-lin√©aire
- Pr√©sence d'art√©facts lors de l'acquisition des donn√©es (pr√©sence d'objects m√©talliques, etc.)
- Etc.

Cette v√©rification de la qualit√© des images permettra d'√©liminer les images inutilisables avant de proc√©der aux analyses statistiques.
Conserver ces derni√®res pourrait avoir des impacts importants sur les r√©sultats ainsi que sur les conclusions tir√©es, c'est pourquoi il est primordial de garder ce risque en t√™te lors du traitement des donn√©es.

```{admonition} Attention
:class: caution attention
:name: controle-qualite-attention
Malheureusement, ce genre de technique est co√ªteuse en terme de ressources de calcul et des erreurs peuvent survenir √† plusieurs niveaux.
Par exemple, cette technique est particuli√®rement peu robuste face aux effets des volumes partiels.
On pourrait en effet avoir une surface qui ne se rend pas jusqu'au fond d'un sulcus, ou lorsque les giri sont tr√®s rapproch√©s, qui ne rentre m√™me pas √† l'int√©rieur du sulcus.
Le r√©sultat de ces deux types d'erreurs, qui sont possibles autant sur la surface piale que sur la surface interne, sera une forte surestimation localis√©e de l'√©paisseur corticale.
C'est pourquoi il est souhaitable de proc√©der √† des contr√¥les de qualit√© fr√©quemment.
```

## Conclusion
Ce chapitre vous a introduit aux diff√©rentes familles de techniques de morphologie computationnelle qu'il est possible d'utiliser avec des donn√©es acquises en imagerie par r√©sonance magn√©tique anatomique. On a discut√© de plusieurs techniques cl√©s d'analyse d'image, et l'on a parl√© de mod√®les statistiques.


## R√©f√©rences

```{bibliography}
:filter: docname in docnames
```

## Exercices

```{admonition} Exercice 3.1
:class: note

Choisissez la meilleure r√©ponse et expliquez pourquoi.
Des donn√©es d‚ÄôIRM T1 individuelle sont...
 1. Une image 3D d‚Äôun cerveau,
 2. Des dizaines d‚Äôimages 2D sagittales d‚Äôun cerveau,
 3. Des centaines d‚Äôimages 2D axiales, coronales et sagittales d‚Äôun cerveau,
 4. Toutes les r√©ponses 1-3.
```

```{admonition} Exercice 3.2
:class: note

On souhaite comparer le volume moyen du putamen droit entre des participants neurotypiques et des participants √©tant sur le spectre de l‚Äôautisme. On consid√®re pour cela deux m√©thodes alternatives: la volum√©trie manuelle et l'analyse VBM.
Citez une force et une faiblesse en lien avec les objectifs de l'√©tude pour chacune de ces techniques.
```

```{admonition} Exercice 3.3
:class: note

Pour chacun des √©nonc√©s suivants, sp√©cifiez si l'affirmation est vraie ou fausse et expliquez votre choix.
 - Les donn√©es IRM T1 doivent √™tre r√©align√©es pour √©tudier la morphologie du cerveau √† l‚Äô√©chelle d‚Äôune population.
 - Les donn√©es d‚ÄôIRM "brutes" (avant pr√©traitement) sont inutilisables pour √©tudier la morphom√©trie.
 - Le lissage spatial est important en VBM, m√™me pour une analyse individuelle.
```

```{admonition} Exercice 3.4
:class: note

Pour chacun des √©nonc√©s suivants, sp√©cifiez si l'affirmation est vraie ou fausse et expliquez votre choix.
 - Les mouvements d‚Äôun participant de recherche peuvent cr√©er du bruit dans une carte VBM.
 - La pr√©sence de m√©tal peut cr√©er du bruit et des d√©formations dans une carte VBM.
 - Un trou dans une carte c√©r√©brale VBM signifie qu'il y a un trou dans le cerveau du participant.
```

```{admonition} Exercice 3.5
:class: note

En v√©rifiant ses donn√©es structurelles, une chercheuse r√©alise qu‚Äôun de ses participants de recherche a un volume c√©r√©bral de deux fois sup√©rieur √† la normale! Pourtant, le cr√¢ne de ce participant semblait normal. Proposez une explication.
```

```{admonition} Exercice 3.6
:class: note

On souhaite faire une comparaison entre la quantit√© de mati√®re grise pr√©sente au niveau du sillon post-central et celle contenue dans le sillon pr√©central, en moyenne, sur une population.
On consid√®re pour cela deux m√©thodes alternatives: une analyse VBM ou bien une analyse de l‚Äô√©paisseur corticale (analyse de surface).
Quelle technique choisiriez-vous et pourquoi?
```

```{admonition} Exercice 3.7
:class: note

Les donn√©es d‚Äôun participant de recherche sont de qualit√© m√©diocre et la segmentation de la mati√®re grise est impr√©cise.
Pour chacune des combinaisons de choix suivantes, quelle technique choisiriez-vous et pourquoi?
 - VBM vs volum√©trie manuelle?
 - VBM vs analyse de surface?
```

```{admonition} Exercice 3.8
:class: note
On a vu quelques exemples exemples de structures anatomiques c√©r√©brales en cours. Faisons un peu de r√©visions... Vous trouverez un visualisateur interactif de cerveau ci dessous, si vous √™tes sur la [page web du cours](morphometrie.html#exercices). Donnez les coordonn√©es (`x`, `y` ou `z`) o√π l'on voit...
* une coupe sagitale avec le corps calleux.
* une coupe corononale avec le corps calleux.
* une coupe axiale avec des ventricules.
* une coupe axiale avec le sillon central.

Pour un rappel concernant les diff√©rents types de coupes du cerveau, veuillez vous r√©f√©rer au {ref}`Chapitre 1: Cartes c√©r√©brales <coupes-tip>`.
```

```{code-cell} ipython 3
:tags: ["hide-input"]
# Ce code r√©cup√®re des donn√©es IRM T1
# et g√©n√®re une image dans trois plans de coupes

# Enl√®ve les warnings
import warnings
warnings.filterwarnings("ignore")

# T√©l√©charge un scan anatomique (template MNI152)
from nilearn.datasets import fetch_icbm152_2009
mni = fetch_icbm152_2009()

# Visualise le volume c√©r√©bral
from nilearn.plotting import view_img

view_img(
    mni.t1,
    bg_img=None,
    black_bg=True,
    cut_coords=[-17, 0, 17],
    title='IRM pond√©r√©e en T1',
    cmap = 'gray',
    symmetric_cmap=False
)
```

```{admonition} Exercice 3.9
:class: note
Pour r√©pondre √† cette question, lisez l'article de Mensen et collaborateurs, "_Development of cortical thickness and surface area in autism spectrum disorder_", publi√© dans Neuroimage Clinical (2017, 13: 215-22) et disponible en libre acc√®s √† cette [adresse](https://www.sciencedirect.com/science/article/pii/S2213158216302406). Les questions suivantes sont √† d√©veloppement court.
* Quel(s) type(s) de participant a(ont) √©t√© recrut√©(s) dans cette √©tude?
* Quel est l'objectif principal de l'√©tude?
* Quels sont les crit√®res d'inclusion et d'exclusion?
* Quelle technique de neuroimagerie est utilis√©e? S'agit-il d'une technique structurelle ou fonctionnelle?
* Quelle s√©quence d'image est utilis√©e? Listez les param√®tres.
* Est ce qu'une √©tape de recalage est appliqu√©e? laquelle?
* Y-a-t-il une proc√©dure de contr√¥le qualit√©? R√©sumez cette proc√©dure.
* Comment les r√©gions d'int√©r√™t sont-elles d√©finies? avec quel atlas? Combien y-a-t-il de r√©gions?
* Quelles mesures morphologiques sont utilis√©es pour chaque r√©gion?
* Quelle figure (ou tableau) r√©pond √† l'objectif principal de l'√©tude?
```
